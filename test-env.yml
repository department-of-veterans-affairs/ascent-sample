version: '3'

services:
  ascent-amqp:
    image: rabbitmq
    hostname: ascent-amqp
    networks:
    - ascentnet
  ascent-discovery:
    image: ascent/ascent-discovery
    hostname: ascent-discovery
    ports:
    - 8761
    environment:
    - SPRING_PROFILES_ACTIVE=aws-ci
    - VAULT_ADDR=${VAULT_ADDR}
    - VAULT_TOKEN=${PLATFORM_VAULT_TOKEN}
    networks:
    - ascentnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/health"]
      interval: 60s
      timeout: 10s
      retries: 3
  ascent-config:
    image: ascent/ascent-config
    ports:
    - 8760
    environment:
    - SPRING_PROFILES_ACTIVE=aws-ci
    - VAULT_ADDR=https://${VAULT_HOST}:8200
    - VAULT_TOKEN=${PLATFORM_VAULT_TOKEN}
    - VAULT_HOST=${VAULT_HOST}
    - VAULT_SCHEME=https
    networks:
    - ascentnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8760/actuator/health"]
      interval: 60s
      timeout: 10s
      retries: 3
  ascent-gateway:
    image: ascent/ascent-gateway
    ports:
    - 8762
    environment:
    - SPRING_PROFILES_ACTIVE=aws-ci
    - VAULT_ADDR=${VAULT_ADDR}
    - VAULT_TOKEN=${PLATFORM_VAULT_TOKEN}
    networks:
    - ascentnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8762/actuator/health"]
      interval: 60s
      timeout: 10s
      retries: 3
  ascent-dashboard:
    image: ascent/ascent-dashboard
    ports:
    - 8763
    environment:
    - SPRING_PROFILES_ACTIVE=aws-ci
    - VAULT_ADDR=${VAULT_ADDR}
    - VAULT_TOKEN=${PLATFORM_VAULT_TOKEN}
    networks:
    - ascentnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8763/actuator/health"]
      interval: 60s
      timeout: 10s
      retries: 3
  ascent-zipkin:
    image: ascent/ascent-zipkin
    ports:
    - 8700
    environment:
    - SPRING_PROFILES_ACTIVE=aws-ci
    - VAULT_ADDR=${VAULT_ADDR}
    - VAULT_TOKEN=${PLATFORM_VAULT_TOKEN}
    networks:
    - ascentnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8700/actuator/health"]
      interval: 60s
      timeout: 10s
      retries: 3

  demo-service:
    image: ascent/demo-service
    ports:
      - 8080
    environment:
      - SPRING_PROFILES_ACTIVE=aws-ci
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_TOKEN=${DEMO_SERVICE_VAULT_TOKEN}
    networks:
      - ascentnet
    deploy:
      placement:
        constraints:
        - node.role == worker
    labels:
      gov.va.ascent.testable: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 60s
      timeout: 10s
      retries: 3
  document-service:
    image: ascent/document-service
    environment:
      - SPRING_PROFILES_ACTIVE=aws-ci
      - VAULT_ADDR=${VAULT_ADDR}
      - VAULT_TOKEN=${DEMO_SERVICE_VAULT_TOKEN}
    networks:
      - ascentnet
    deploy:
      placement:
        constraints:
        - node.role == worker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/actuator/health"]
      interval: 60s
      timeout: 10s
      retries: 3
  redis-master:
    image: redis:4.0.1-alpine
    networks:
      - ascentnet
    deploy:
      placement:
        constraints:
        - node.role == worker
  redis-slave:
    image: redis:4.0.1-alpine
    command: redis-server --slaveof redis-master 6379
    links:
      - redis-master
    networks:
      - ascentnet
      
  # Instance 1
  redis-sentinel:
    image: ascent/redis-sentinel
    links:
      - redis-master
    networks:
      - ascentnet
      
  # Instance 2
  redis-sentinel2:
    image: ascent/redis-sentinel
    links:
      - redis-master
    networks:
      - ascentnet
  
  # Instance 3
  redis-sentinel3:
    image: ascent/redis-sentinel
    links:
      - redis-master
    networks:
      - ascentnet
  
networks:
  ascentnet:
    driver: overlay